I need you to build a complete Attendance Management System Backend with the following requirements:
System Overview:
This is a backend API for an attendance tracking system where:

Employees check in/out daily via an Electron desktop app
The system tracks active time, idle time, and lunch breaks
Screenshots are captured every 10 minutes
User activity is monitored (active window, application usage, mouse/keyboard activity)
Admin can view daily, weekly, and monthly reports


Technology Stack:

Language: Node.js with Express.js (or FastAPI with Python if you prefer)
Database: PostgreSQL
Authentication: JWT tokens
File Storage: Local storage for now (can be upgraded to S3 later)
Real-time: WebSocket support for live updates
Cache: Redis for session management and real-time data


Database Schema:
Create these tables in PostgreSQL:
1. users
sqlCREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    employee_id VARCHAR(50) UNIQUE NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('employee', 'admin')),
    profile_picture_url TEXT,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'terminated')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
2. attendance_records
sqlCREATE TABLE attendance_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    check_in_time TIMESTAMP NOT NULL,
    check_out_time TIMESTAMP,
    total_work_duration INTEGER DEFAULT 0,
    total_active_duration INTEGER DEFAULT 0,
    total_idle_duration INTEGER DEFAULT 0,
    total_break_duration INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'present' CHECK (status IN ('present', 'absent', 'half_day', 'on_leave')),
    check_in_ip VARCHAR(45),
    check_out_ip VARCHAR(45),
    check_in_location JSONB,
    check_out_location JSONB,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_user_date UNIQUE(user_id, date)
);
3. activity_logs
sqlCREATE TABLE activity_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    attendance_record_id UUID REFERENCES attendance_records(id) ON DELETE CASCADE,
    activity_type VARCHAR(20) NOT NULL CHECK (activity_type IN ('active', 'idle', 'lunch_break', 'meeting')),
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    duration INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
4. user_activity_tracking
sqlCREATE TABLE user_activity_tracking (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    attendance_record_id UUID REFERENCES attendance_records(id) ON DELETE CASCADE,
    timestamp TIMESTAMP NOT NULL,
    active_window_title TEXT,
    active_application VARCHAR(255),
    url TEXT,
    mouse_clicks INTEGER DEFAULT 0,
    keyboard_strokes INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    idle_time_seconds INTEGER DEFAULT 0,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
5. screenshots
sqlCREATE TABLE screenshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    attendance_record_id UUID REFERENCES attendance_records(id) ON DELETE CASCADE,
    timestamp TIMESTAMP NOT NULL,
    screenshot_url TEXT NOT NULL,
    thumbnail_url TEXT,
    file_size_kb INTEGER,
    active_window_title TEXT,
    active_application VARCHAR(255),
    screen_resolution VARCHAR(20),
    blur_applied BOOLEAN DEFAULT false,
    is_productive BOOLEAN,
    category VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
6. lunch_breaks
sqlCREATE TABLE lunch_breaks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    attendance_record_id UUID NOT NULL REFERENCES attendance_records(id) ON DELETE CASCADE,
    break_start_time TIMESTAMP NOT NULL,
    break_end_time TIMESTAMP,
    duration INTEGER,
    start_location JSONB,
    end_location JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
7. productivity_summary
sqlCREATE TABLE productivity_summary (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    total_tracked_time INTEGER DEFAULT 0,
    productive_time INTEGER DEFAULT 0,
    unproductive_time INTEGER DEFAULT 0,
    neutral_time INTEGER DEFAULT 0,
    top_applications JSONB,
    top_websites JSONB,
    total_screenshots INTEGER DEFAULT 0,
    total_mouse_clicks INTEGER DEFAULT 0,
    total_keyboard_strokes INTEGER DEFAULT 0,
    productivity_score INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_user_date_summary UNIQUE(user_id, date)
);
8. system_settings
sqlCREATE TABLE system_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value JSONB NOT NULL,
    description TEXT,
    updated_by UUID REFERENCES users(id),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Add appropriate indexes on all foreign keys and frequently queried columns.

---

### **API Endpoints Required:**

#### **Authentication**
```
POST   /api/auth/register
POST   /api/auth/login
POST   /api/auth/logout
POST   /api/auth/refresh-token
GET    /api/auth/me
```

#### **Attendance Management**
```
POST   /api/attendance/check-in
POST   /api/attendance/check-out
GET    /api/attendance/status
GET    /api/attendance/today
GET    /api/attendance/history?start_date=&end_date=&user_id=
PUT    /api/attendance/:id/notes
```

#### **Lunch Breaks**
```
POST   /api/lunch-break/start
POST   /api/lunch-break/end
GET    /api/lunch-break/current
```

#### **Activity Tracking**
```
POST   /api/activity/heartbeat
POST   /api/activity/log
GET    /api/activity/current
GET    /api/activity/history?date=
```

#### **Screenshots**
```
POST   /api/screenshots/upload
GET    /api/screenshots/list?date=&user_id=
GET    /api/screenshots/:id
DELETE /api/screenshots/:id
```

#### **Reports (Admin)**
```
GET    /api/reports/daily?date=&user_id=
GET    /api/reports/weekly?start_date=&user_id=
GET    /api/reports/monthly?month=&year=&user_id=
GET    /api/reports/productivity-summary?user_id=&period=
GET    /api/reports/team-overview?date=
GET    /api/reports/export?format=csv|pdf&type=daily|weekly|monthly
```

#### **User Management (Admin)**
```
GET    /api/users
POST   /api/users
GET    /api/users/:id
PUT    /api/users/:id
DELETE /api/users/:id
GET    /api/users/:id/attendance-summary
```

#### **Settings**
```
GET    /api/settings
PUT    /api/settings/:key

Key Business Logic:

Check-in Process:

Create attendance_record for today
Start active activity_log
Record IP and location (if provided)
Return attendance record ID


Activity Heartbeat (every 30 seconds from Electron app):

Receive: user_id, timestamp, is_active, active_window, application, mouse_clicks, keyboard_strokes
Store in user_activity_tracking table
Update current activity_log (if idle > 5 minutes, close active log and create idle log)
Cache in Redis for real-time status


Idle Detection:

If no heartbeat received for 5 minutes → mark as idle
Create idle activity_log entry
When activity resumes → close idle log, create active log


Lunch Break:

Create lunch_breaks record with start time
Pause activity tracking
On end: update end time and calculate duration
Resume activity tracking


Check-out Process:

Close all open activity_logs
Close lunch_breaks if still open
Calculate totals:

total_work_duration = check_out_time - check_in_time
total_active_duration = sum of all 'active' activity_logs
total_idle_duration = sum of all 'idle' activity_logs
total_break_duration = sum of all lunch_breaks


Update attendance_record


Screenshot Upload:

Receive screenshot file (base64 or multipart)
Save to local storage (./uploads/screenshots/{user_id}/{date}/{timestamp}.jpg)
Create thumbnail (optional)
Store metadata in screenshots table
Link to attendance_record_id


Daily Aggregation (Background Job - runs at midnight):

For each user's attendance_record of previous day:

Calculate final durations from activity_logs
Count total screenshots
Sum mouse_clicks and keyboard_strokes
Aggregate top applications and websites (from user_activity_tracking)
Calculate productivity_score (based on active time %)
Insert into productivity_summary table




Reports Generation:

Daily: Single day's attendance + activity breakdown
Weekly: 7 days aggregated + trends
Monthly: 30 days aggregated + charts data
Include: total hours, active %, idle %, top apps, productivity score




Additional Requirements:

Validation:

Can't check-out before check-in
Can't start lunch break if not checked in
Validate timestamps are not in future


Security:

Hash passwords with bcrypt
JWT authentication on all endpoints (except login/register)
Role-based access control (employees can only see their own data, admins can see all)
Rate limiting on login endpoint
Validate file uploads (type, size)


Error Handling:

Return proper HTTP status codes
Consistent error response format:



json     {
       "success": false,
       "error": {
         "code": "ERROR_CODE",
         "message": "Human readable message"
       }
     }

Response Format:

json   {
     "success": true,
     "data": { ... },
     "message": "Optional success message"
   }
```

5. **Environment Variables:**
```
   PORT=3000
   DATABASE_URL=postgresql://user:pass@localhost:5432/attendance_db
   JWT_SECRET=your-secret-key
   JWT_EXPIRY=24h
   REDIS_URL=redis://localhost:6379
   UPLOAD_DIR=./uploads
   MAX_FILE_SIZE=5MB
```

6. **Seeding Data:**
   - Create 1 admin user (admin@company.com / admin123)
   - Create 2-3 sample employee users
   - Insert default system_settings

---

### **Folder Structure:**
```
attendance-backend/
├── src/
│   ├── config/
│   │   ├── database.js
│   │   └── redis.js
│   ├── middleware/
│   │   ├── auth.js
│   │   ├── errorHandler.js
│   │   └── validation.js
│   ├── routes/
│   │   ├── auth.js
│   │   ├── attendance.js
│   │   ├── activity.js
│   │   ├── screenshots.js
│   │   ├── reports.js
│   │   └── users.js
│   ├── controllers/
│   │   ├── authController.js
│   │   ├── attendanceController.js
│   │   ├── activityController.js
│   │   ├── screenshotController.js
│   │   ├── reportController.js
│   │   └── userController.js
│   ├── services/
│   │   ├── attendanceService.js
│   │   ├── activityService.js
│   │   ├── reportService.js
│   │   └── aggregationService.js
│   ├── models/
│   │   └── (if using ORM like Sequelize/Prisma)
│   ├── utils/
│   │   ├── logger.js
│   │   ├── validators.js
│   │   └── helpers.js
│   ├── jobs/
│   │   └── dailyAggregation.js
│   └── index.js
├── uploads/
│   └── screenshots/
├── .env
├── package.json
└── README.md
```

---

### **Testing Requirements:**

Create a `test.http` file or Postman collection with sample requests for:
1. Register user
2. Login
3. Check-in
4. Send activity heartbeat
5. Upload screenshot
6. Start/end lunch break
7. Check-out
8. Get daily report

---

### **Deliverables:**

1. ✅ Complete working backend with all endpoints
2. ✅ Database schema with migrations
3. ✅ Seed data script
4. ✅ Authentication & authorization working
5. ✅ File upload handling for screenshots
6. ✅ Background job for daily aggregation
7. ✅ Basic error handling and validation
8. ✅ README with setup instructions
9. ✅ API documentation (inline comments or separate doc)
10. ✅ Sample `.env.example` file

---

### **Nice to Have (if time permits):**

- WebSocket support for real-time status updates
- Email notifications for daily reports
- Export reports to CSV/PDF
- Request logging
---

**Please build this complete backend system. Start with the database setup, then authentication, then core 